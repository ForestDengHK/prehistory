---
import type { Creature } from '../data/creatures';
import { creatures } from '../data/creatures';

// Configuration - number of items in carousel
const CAROUSEL_SIZE = 15;

// Function to truncate description while preserving HTML/markdown tags
function truncateDescription(description: string) {
  // Skip the header boilerplate (# Title and ## Overview) - start from actual content
  let tempText = description.replace(/^#[^#]*?##\s*Overview\s*\n+/s, '');
  // Also handle horizontal rules
  tempText = tempText.replace(/^---\s*\n+/gm, '');
  // Convert markdown bold to HTML
  tempText = tempText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  const words = tempText.split(' ');

  if (words.length <= 25) return tempText;

  let count = 0;
  let result = [];
  let inTag = false;
  let currentTag = '';

  for (const word of words) {
    if (count >= 25 && !inTag) break;

    // Check for opening tags
    if (word.includes('<') && !word.includes('</')) {
      inTag = true;
      currentTag = word.substring(word.indexOf('<')+1, word.indexOf('>'));
    }

    result.push(word);

    // Check for closing tags
    if (word.includes('</')) {
      inTag = false;
      currentTag = '';
    }

    if (!inTag && !word.includes('>')) count++;
  }

  // Close any open tags
  if (inTag) {
    result.push(`</${currentTag}>`);
  }

  return result.join(' ') + '...';
}

// Get the most recently updated creatures
const latestCreatures = creatures
  .filter((creature): creature is Creature & { lastUpdated: number } =>
    typeof creature.lastUpdated === 'number' && creature.lastUpdated > 0
  )
  .sort((a, b) => b.lastUpdated - a.lastUpdated)
  .slice(0, CAROUSEL_SIZE);
---

<section class="latest-discovery">
  <div class="header">
    <div class="title-group">
      <span class="badge">New</span>
      <h2>Latest Discoveries</h2>
    </div>
    <div class="carousel-nav">
      <button class="nav-arrow nav-prev" aria-label="Previous">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <div class="carousel-dots">
        {latestCreatures.map((_, i) => (
          <button class={`dot ${i === 0 ? 'active' : ''}`} data-index={i} aria-label={`Slide ${i + 1}`}></button>
        ))}
      </div>
      <button class="nav-arrow nav-next" aria-label="Next">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </div>

  <div class="carousel-wrapper">
    <div class="carousel-track">
      {latestCreatures.map((creature, index) => (
        <div class="discovery-card" data-index={index}>
          <div class="image-section">
            <img src={creature.image} alt={creature.name} width="600" height="400" loading={index === 0 ? "eager" : "lazy"} />
          </div>
          <div class="content-section">
            <p class="discovered-date">
              {new Date(creature.lastUpdated).toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
              })}
            </p>
            <h3>{creature.name}</h3>
            <p class="period">{creature.period}</p>

            <p class="description" set:html={truncateDescription(creature.description)}></p>

            <div class="details">
              <div class="detail-row">
                <span>Location:</span> {creature.location}
              </div>
              <div class="detail-row">
                <span>Scientific Name:</span> <em>{creature.scientificName}</em>
              </div>
            </div>

            <a href={`/creature/${creature.id}`} class="read-more">
              Read Full Discovery
            </a>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  const track = document.querySelector('.carousel-track') as HTMLElement;
  const cards = document.querySelectorAll('.discovery-card');
  const dots = document.querySelectorAll('.dot');
  const prevBtn = document.querySelector('.nav-prev');
  const nextBtn = document.querySelector('.nav-next');

  let current = 0;
  const total = cards.length;

  function goTo(index: number) {
    if (index < 0) index = total - 1;
    if (index >= total) index = 0;
    current = index;

    track.style.transform = `translateX(-${current * 100}%)`;

    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === current);
    });
  }

  prevBtn?.addEventListener('click', () => goTo(current - 1));
  nextBtn?.addEventListener('click', () => goTo(current + 1));

  dots.forEach((dot, i) => {
    dot.addEventListener('click', () => goTo(i));
  });

  // Touch support
  let startX = 0;
  track?.addEventListener('touchstart', (e) => {
    startX = (e as TouchEvent).touches[0].clientX;
  }, { passive: true });

  track?.addEventListener('touchend', (e) => {
    const diff = startX - (e as TouchEvent).changedTouches[0].clientX;
    if (Math.abs(diff) > 50) {
      goTo(current + (diff > 0 ? 1 : -1));
    }
  }, { passive: true });
</script>

<style>
  .latest-discovery {
    padding: 1rem 0;
    max-width: 1200px;
    margin: 0 auto;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 1rem;
  }

  .title-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .badge {
    display: inline-block;
    background-color: var(--accent-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 700;
    width: fit-content;
    text-transform: uppercase;
  }

  h2 {
    font-size: 1.875rem;
    font-weight: 700;
    margin: 0;
    color: var(--primary-color);
  }

  /* Carousel Navigation */
  .carousel-nav {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .nav-arrow {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid var(--card-border, #e0e0e0);
    background: var(--card-bg);
    color: var(--primary-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .nav-arrow:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
  }

  .nav-arrow:focus-visible {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
  }

  .carousel-dots {
    display: flex;
    gap: 0.5rem;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    background: var(--text-muted);
    opacity: 0.4;
    cursor: pointer;
    padding: 0;
    transition: all 0.2s ease;
  }

  .dot:hover {
    opacity: 0.7;
  }

  .dot.active {
    background: var(--accent-color);
    opacity: 1;
    transform: scale(1.2);
  }

  /* Carousel */
  .carousel-wrapper {
    overflow: hidden;
    border-radius: 8px;
  }

  .carousel-track {
    display: flex;
    transition: transform 0.4s ease;
  }

  .discovery-card {
    min-width: 100%;
    display: flex;
    background: var(--card-bg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px var(--shadow-color);
  }

  .image-section {
    flex: 1;
    background: var(--surface-elevated);
    min-height: 400px;
    overflow: hidden;
  }

  .image-section img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .discovery-card:hover .image-section img {
    transform: scale(1.02);
  }

  .content-section {
    flex: 1;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .discovered-date {
    color: var(--accent-color);
    font-size: 0.8rem;
    font-weight: 700;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  h3 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    color: var(--primary-color);
  }

  .period {
    color: var(--text-muted);
    margin: 0;
    font-size: 0.875rem;
  }

  .description {
    color: var(--text-muted);
    font-size: 0.875rem;
    line-height: 1.6;
    margin: 0;
  }

  .details {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    margin-top: auto;
  }

  .detail-row {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .detail-row span {
    font-weight: 700;
    color: var(--primary-color);
  }

  .detail-row em {
    font-style: italic;
  }

  .read-more {
    display: inline-flex;
    align-items: center;
    background: var(--accent-color);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 700;
    width: fit-content;
    margin-top: 0.5rem;
    transition: opacity 0.2s ease;
  }

  .read-more:hover {
    opacity: 0.85;
    color: white;
  }

  .read-more:focus-visible {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
  }

  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .discovery-card {
      flex-direction: column;
    }

    .image-section {
      min-height: auto;
      aspect-ratio: 3 / 2;
    }

    .content-section {
      padding: 1rem;
    }
  }
</style>
