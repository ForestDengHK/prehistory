---
interface Props {
  creatureId: string;
  category: string;
  period: string;
}

const { creatureId, category, period } = Astro.props;
---

<div class="discovery-tracker-wrapper">
  <div id="discovery-tracker" data-creature-id={creatureId} data-category={category} data-period={period}>
    <div class="discovery-status">
      <!-- Content populated by JavaScript -->
    </div>
  </div>
</div>

<script>
  class DiscoveryTracker {
    private static STORAGE_KEY = 'prehistory_discoveries';
    private static instance: DiscoveryTracker;
    private discoveries: any;

    private constructor() {
      this.discoveries = this.getDiscoveries();
      this.initializeDiscovery();

      window.addEventListener('storage', (e) => {
        if (e.key === DiscoveryTracker.STORAGE_KEY) {
          if (!e.newValue) {
            DiscoveryTracker.instance = null;
            this.discoveries = this.getDiscoveries();
          } else {
            this.discoveries = JSON.parse(e.newValue);
          }
          this.updateDiscoveryStatus();
        }
      });
    }

    static getInstance(): DiscoveryTracker {
      if (!DiscoveryTracker.instance) {
        DiscoveryTracker.instance = new DiscoveryTracker();
      }
      return DiscoveryTracker.instance;
    }

    private initializeDiscovery() {
      const tracker = document.getElementById('discovery-tracker');
      if (!tracker) return;

      const creatureId = tracker.getAttribute('data-creature-id');
      const category = tracker.getAttribute('data-category');
      const period = tracker.getAttribute('data-period');

      if (creatureId) {
        this.recordDiscovery(creatureId, category!, period!);
        this.updateDiscoveryStatus();
      }
    }

    private recordDiscovery(creatureId: string, category: string, period: string) {
      const discoveries = this.getDiscoveries();
      if (!discoveries.creatures.includes(creatureId)) {
        const oldCount = discoveries.creatures.length;
        const oldStreak = discoveries.currentStreak;

        discoveries.creatures.push(creatureId);
        discoveries.categories[category] = (discoveries.categories[category] || 0) + 1;
        discoveries.periods[period] = (discoveries.periods[period] || 0) + 1;

        const today = new Date().setHours(0,0,0,0);
        const lastVisit = new Date(discoveries.lastVisited).setHours(0,0,0,0);
        const oneDayMs = 24 * 60 * 60 * 1000;

        if (today - lastVisit === oneDayMs) {
          discoveries.currentStreak += 1;
          discoveries.maxStreak = Math.max(discoveries.currentStreak, discoveries.maxStreak);
        } else if (today === lastVisit) {
          // Already visited today
        } else if (today - lastVisit > oneDayMs) {
          discoveries.currentStreak = 1;
        }

        discoveries.lastVisited = new Date().toISOString();
        this.saveDiscoveries(discoveries);
        this.checkAndNotifyAchievements(oldCount, discoveries.creatures.length, oldStreak, discoveries.currentStreak);
      }
    }

    private getDiscoveries() {
      const defaultDiscoveries = {
        creatures: [] as string[],
        categories: {} as Record<string, number>,
        periods: {} as Record<string, number>,
        lastVisited: new Date().toISOString(),
        currentStreak: 0,
        maxStreak: 0
      };

      const stored = localStorage.getItem(DiscoveryTracker.STORAGE_KEY);
      if (!stored) return defaultDiscoveries;

      try {
        const parsed = JSON.parse(stored);
        if (!Array.isArray(parsed.creatures)) return defaultDiscoveries;
        return parsed;
      } catch (e) {
        return defaultDiscoveries;
      }
    }

    private saveDiscoveries(discoveries: any) {
      this.discoveries = discoveries;
      localStorage.setItem(DiscoveryTracker.STORAGE_KEY, JSON.stringify(discoveries));
      this.updateDiscoveryStatus();
    }

    private updateDiscoveryStatus() {
      const discoveries = this.getDiscoveries();
      const statusDiv = document.querySelector('.discovery-status');
      if (!statusDiv) return;

      const discoveryCount = discoveries.creatures?.length || 0;
      const currentStreak = discoveries.currentStreak || 0;

      // Get discovery level and color
      let discoveryLevel = { icon: 'ü•ö', title: 'Beginner', color: '#95a5a6', next: 5 };
      if (discoveryCount >= 100) discoveryLevel = { icon: 'üëë', title: 'Master', color: '#f1c40f', next: null };
      else if (discoveryCount >= 50) discoveryLevel = { icon: 'üèÜ', title: 'Expert', color: '#e67e22', next: 100 };
      else if (discoveryCount >= 25) discoveryLevel = { icon: 'üéØ', title: 'Advanced', color: '#9b59b6', next: 50 };
      else if (discoveryCount >= 10) discoveryLevel = { icon: '‚≠ê', title: 'Explorer', color: '#3498db', next: 25 };
      else if (discoveryCount >= 5) discoveryLevel = { icon: 'üåü', title: 'Novice', color: '#27ae60', next: 10 };

      // Get streak level
      let streakLevel = { icon: 'üî•', title: 'Starting', color: '#95a5a6' };
      if (currentStreak >= 30) streakLevel = { icon: 'üåã', title: 'On Fire!', color: '#e74c3c' };
      else if (currentStreak >= 14) streakLevel = { icon: 'üí´', title: 'Amazing!', color: '#f39c12' };
      else if (currentStreak >= 7) streakLevel = { icon: '‚ö°', title: 'Great!', color: '#f1c40f' };
      else if (currentStreak >= 3) streakLevel = { icon: 'üî•', title: 'Nice!', color: '#e67e22' };

      // Calculate progress to next level
      const progressPercent = discoveryLevel.next
        ? Math.min(100, (discoveryCount / discoveryLevel.next) * 100)
        : 100;

      statusDiv.innerHTML = `
        <div class="tracker-cards">
          <div class="tracker-card discoveries" style="--card-color: ${discoveryLevel.color}">
            <div class="card-icon">${discoveryLevel.icon}</div>
            <div class="card-content">
              <div class="card-value">${discoveryCount}</div>
              <div class="card-label">Discovered</div>
              ${discoveryLevel.next ? `
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${progressPercent}%"></div>
                </div>
                <div class="progress-text">${discoveryLevel.next - discoveryCount} more to ${discoveryLevel.next >= 100 ? 'Master' : 'level up'}!</div>
              ` : `<div class="progress-text">Max level reached! üéâ</div>`}
            </div>
          </div>

          <div class="tracker-card streak" style="--card-color: ${streakLevel.color}">
            <div class="card-icon">${streakLevel.icon}</div>
            <div class="card-content">
              <div class="card-value">${currentStreak}</div>
              <div class="card-label">Day Streak</div>
              <div class="streak-status">${streakLevel.title}</div>
            </div>
          </div>

          <a href="/achievements" class="tracker-card achievements-link">
            <div class="card-icon">üèÖ</div>
            <div class="card-content">
              <div class="card-sublabel">Achievements</div>
            </div>
            <div class="card-arrow">‚Üí</div>
          </a>
        </div>
      `;
    }

    private checkAndNotifyAchievements(oldCount: number, newCount: number, oldStreak: number, newStreak: number) {
      const discoveryMilestones = [
        { count: 100, icon: 'üëë', title: 'Master Explorer!' },
        { count: 50, icon: 'üèÜ', title: 'Expert Explorer!' },
        { count: 25, icon: 'üéØ', title: 'Advanced Explorer!' },
        { count: 10, icon: '‚≠ê', title: 'Explorer!' },
        { count: 5, icon: 'üåü', title: 'Novice Explorer!' }
      ];

      const streakMilestones = [
        { count: 30, icon: 'üåã', title: '30 Day Streak!' },
        { count: 14, icon: 'üí´', title: '2 Week Streak!' },
        { count: 7, icon: '‚ö°', title: 'Week Streak!' },
        { count: 3, icon: 'üî•', title: '3 Day Streak!' }
      ];

      for (const milestone of discoveryMilestones) {
        if (oldCount < milestone.count && newCount >= milestone.count) {
          this.showAchievementNotification(milestone.icon, milestone.title);
          break;
        }
      }

      for (const milestone of streakMilestones) {
        if (oldStreak < milestone.count && newStreak >= milestone.count) {
          this.showAchievementNotification(milestone.icon, milestone.title);
          break;
        }
      }
    }

    private showAchievementNotification(icon: string, title: string) {
      const notification = document.createElement('div');
      notification.className = 'achievement-notification';
      notification.innerHTML = `
        <div class="achievement-content">
          <span class="achievement-icon">${icon}</span>
          <div class="achievement-text">
            <div class="achievement-label">Achievement Unlocked!</div>
            <div class="achievement-title">${title}</div>
          </div>
        </div>
      `;
      document.body.appendChild(notification);

      requestAnimationFrame(() => notification.classList.add('show'));

      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    DiscoveryTracker.getInstance();
  });
</script>

<style is:global>
  .discovery-tracker-wrapper {
    margin: 0 0 1rem 0;
  }

  .tracker-cards {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .tracker-card {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    background: white;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-left: 4px solid var(--card-color, var(--primary-color));
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    flex: 1 1 auto;
    min-width: 140px;
  }

  .tracker-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  }

  .card-icon {
    font-size: 1.75rem;
    line-height: 1;
  }

  .card-content {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .card-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary-color);
    line-height: 1;
  }

  .card-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--secondary-color);
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .progress-bar {
    width: 80px;
    height: 4px;
    background: #e0e0e0;
    border-radius: 2px;
    margin-top: 0.375rem;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--card-color, var(--fun-green));
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  .progress-text {
    font-size: 0.625rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
  }

  .streak-status {
    font-size: 0.6875rem;
    font-weight: 700;
    color: var(--card-color);
    margin-top: 0.25rem;
  }

  /* Achievements link card */
  .achievements-link {
    text-decoration: none;
    color: inherit;
    border-left-color: var(--fun-purple);
    cursor: pointer;
    align-items: center;
  }

  .achievements-link .card-content {
    display: flex;
    align-items: center;
  }

  .achievements-link .card-sublabel {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--primary-color);
  }

  .card-arrow {
    font-size: 1.25rem;
    color: var(--fun-purple);
    margin-left: auto;
    transition: transform 0.2s ease;
  }

  .achievements-link:hover .card-arrow {
    transform: translateX(4px);
  }

  /* Achievement notification */
  .achievement-notification {
    position: fixed;
    bottom: 100px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
    z-index: 1000;
    transform: translateX(120%);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  .achievement-notification.show {
    transform: translateX(0);
    opacity: 1;
  }

  .achievement-content {
    display: flex;
    align-items: center;
    gap: 0.875rem;
  }

  .achievement-notification .achievement-icon {
    font-size: 2rem;
    animation: bounce 0.5s ease infinite alternate;
  }

  .achievement-label {
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.9;
  }

  .achievement-title {
    font-size: 1rem;
    font-weight: 700;
  }

  @keyframes bounce {
    from { transform: scale(1); }
    to { transform: scale(1.1); }
  }

  @media (max-width: 500px) {
    .tracker-cards {
      flex-direction: column;
    }

    .tracker-card {
      width: 100%;
      min-width: unset;
    }

    .achievement-notification {
      left: 20px;
      right: 20px;
      bottom: 80px;
    }
  }
</style>
