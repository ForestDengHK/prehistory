---
import Layout from '../../layouts/Layout.astro';
import Pagination from '../../components/Pagination.astro';
import { timelinePeriods } from '../../data/timeline';
import { creatures } from '../../data/creatures';
import { marked } from 'marked';

// Get the period from URL params
const { period: periodParam } = Astro.params;

// Find the matching period
const period = timelinePeriods.find(p =>
  p.name.toLowerCase() === periodParam?.toLowerCase()
);

// Redirect to 404 if period not found
if (!period) {
  return Astro.redirect('/404');
}

// Filter creatures for this period
const allPeriodCreatures = creatures.filter(creature =>
  creature.period && creature.period.toLowerCase().includes(period.name.toLowerCase())
);

// Pagination
const ITEMS_PER_PAGE = 18;
const page = Math.max(1, parseInt(Astro.url.searchParams.get('page') || '1'));
const totalPages = Math.ceil(allPeriodCreatures.length / ITEMS_PER_PAGE);
const startIndex = (page - 1) * ITEMS_PER_PAGE;
const periodCreatures = allPeriodCreatures.slice(startIndex, startIndex + ITEMS_PER_PAGE);

// Parse markdown description
const detailedDescriptionHtml = marked(period.detailedDescription) as string;

// Create SEO description
const seoDescription = `Explore the ${period.name} Period (${period.period}). ${period.description}. Discover ${allPeriodCreatures.length} fascinating creatures that lived during this time.`;

// Create structured data for the period
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": `${period.name} Period - Prehistoric Timeline`,
  "description": seoDescription,
  "image": period.image,
  "author": {
    "@type": "Person",
    "name": "Xinhao"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Prehistoric World",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.xinhao.eu/images/logo.png"
    }
  },
  "datePublished": "2024-01-01T00:00:00Z",
  "dateModified": new Date().toISOString(),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://www.xinhao.eu/timeline/${period.name.toLowerCase()}`
  },
  "about": {
    "@type": "Thing",
    "name": `${period.name} Period`,
    "description": period.description,
    "temporal": period.period
  },
  "keywords": [
    period.name,
    "prehistoric period",
    "geological timeline",
    "prehistoric creatures",
    "ancient Earth",
    "evolution",
    ...allPeriodCreatures.map(c => c.name)
  ].join(", ")
};
---

<Layout 
  title={`${period.name} Period`}
  description={seoDescription}
  image={period.image}
  type="article"
>
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  
  <div class="period-container">
    <div class="period-hero" style={`background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url(${period.image})`}>
      <h1>{period.name} Period</h1>
      <p class="period-time">{period.period}</p>
    </div>

    <div class="period-content">
      <section class="period-info">
        <h2>About this Period</h2>
        <p class="brief-description">{period.description}</p>
        <div class="detailed-description">
          <div class="markdown-content" set:html={detailedDescriptionHtml} />
        </div>
      </section>

      <section class="period-creatures">
        <h2>Creatures from this Period ({allPeriodCreatures.length})</h2>
        {periodCreatures.length > 0 ? (
          <div class="creatures-grid">
            {periodCreatures.map(creature => (
              <a href={`/creature/${creature.id}`} class="creature-card">
                <div class="creature-image">
                  <img src={creature.image} alt={creature.name} loading="lazy" />
                </div>
                <div class="creature-info">
                  <h3>{creature.name}</h3>
                  <p class="scientific-name">{creature.scientificName}</p>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <p class="no-creatures">No creatures found from this period.</p>
        )}
        <Pagination currentPage={page} totalPages={totalPages} />
      </section>
    </div>
  </div>
</Layout>

<style>
  .period-container {
    margin: -2rem;
  }

  .period-hero {
    padding: 4rem 2rem;
    text-align: center;
    color: white;
    background-size: cover;
    background-position: center;
  }

  .period-hero h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: white;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  }

  .period-time {
    font-size: 1.25rem;
    opacity: 0.9;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  }

  .period-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  section {
    margin-bottom: 3rem;
  }

  h2 {
    color: var(--primary-color);
    margin-bottom: 1.5rem;
  }

  .brief-description {
    font-size: 1.25rem;
    margin-bottom: 0;
    color: var(--secondary-color);
    line-height: 1.6;
  }

  .detailed-description {
    background: var(--card-bg);
    padding: 2.5rem 3rem;
    border-radius: 12px;
    margin-top: 2rem;
    box-shadow: 0 4px 20px var(--shadow-color);
  }

  /* Prose Content Styling */
  .markdown-content {
    color: var(--text-color);
    line-height: 1.85;
    font-size: 1.1rem;
  }

  .markdown-content p {
    margin-bottom: 1.5rem;
    text-align: left;
  }

  .markdown-content p:last-child {
    margin-bottom: 0;
  }

  .markdown-content strong {
    color: var(--primary-color);
    font-weight: 600;
  }

  .markdown-content em {
    font-style: italic;
    color: var(--text-muted);
    display: block;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--card-border);
    font-size: 1rem;
  }

  .markdown-content a {
    color: var(--accent-color);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s ease;
  }

  .markdown-content a:hover {
    border-bottom-color: var(--accent-color);
  }

  .creatures-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
    padding: 2rem;
    max-width: 1200px;
    margin: 0 auto;
    justify-content: center;
  }

  .creature-card {
    background: var(--card-bg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px var(--shadow-color);
    transition: transform 0.3s ease, background-color 0.3s ease;
    text-decoration: none;
    color: inherit;
  }

  .creature-card:hover {
    transform: translateY(-5px);
  }

  .creature-image {
    height: 200px;
    overflow: hidden;
  }

  .creature-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .creature-info {
    padding: 1.5rem;
  }

  .creature-info h3 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
  }

  .scientific-name {
    color: var(--secondary-color);
    font-style: italic;
  }

  .no-creatures {
    text-align: center;
    padding: 2rem;
    background: var(--surface-elevated);
    border-radius: 8px;
    color: var(--text-muted);
  }

  @media (max-width: 768px) {
    .period-hero h1 {
      font-size: 2rem;
    }

    .period-hero p {
      font-size: 1rem;
    }

    .detailed-description {
      padding: 1.5rem 1.25rem;
    }

    .markdown-content {
      font-size: 1rem;
    }

    .creatures-grid {
      grid-template-columns: 1fr;
      padding: 1rem;
    }
  }
</style>