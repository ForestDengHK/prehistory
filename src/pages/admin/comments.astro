---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getRedis } from '../../lib/redis';
import { creatures } from '../../data/creatures';

let allComments: Comment[] = [];
let error: string | null = null;

interface Comment {
    id: string;
    name: string;
    comment: string;
    createdAt: string;
    email?: string;
    emoji?: string;
    creatureId?: string;
}

// Create a map of creature IDs to names for quick lookup
const creatureMap = new Map(creatures.map(c => [c.id, c.name]));

// Function to get all comments from Redis
async function getAllComments(): Promise<Comment[]> {
    const redis = getRedis();
    const comments: Comment[] = [];

    // Scan for all comment sorted set keys
    let cursor: string | number = 0;
    const commentKeys: string[] = [];
    let iterations = 0;
    const MAX_ITERATIONS = 10; // Safeguard against runaway loops

    do {
        const scanResult = await redis.scan(cursor, {
            match: '*:comments',
            count: 100
        });
        cursor = scanResult[0];
        const keys = scanResult[1];
        commentKeys.push(...keys);
        iterations++;
        if (iterations >= MAX_ITERATIONS) {
            console.warn('[Redis] Comments scan hit max iterations, breaking to prevent runaway');
            break;
        }
    } while (cursor != 0);

    // Process each comment key
    for (const key of commentKeys) {
        let creatureId: string;
        if (key === 'about:comments') {
            creatureId = 'about';
        } else {
            const match = key.match(/^creature:(.+):comments$/);
            if (!match) continue;
            creatureId = match[1];
        }

        const commentIds = await redis.zrange(key, 0, -1, { rev: true });

        for (const id of commentIds) {
            const comment = await redis.get<Comment>(`comment:${id}`);
            if (comment) {
                comments.push({
                    ...comment,
                    creatureId
                });
            }
        }
    }

    comments.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
    return comments;
}

try {
    allComments = await getAllComments();
} catch (e) {
    error = e instanceof Error ? e.message : 'An unknown error occurred';
    console.error('Error loading comments:', e);
}

// Helper to format date
function formatDate(dateStr: string) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}
---

<AdminLayout title="Comments">
    <header class="page-header">
        <div class="header-content">
            <div>
                <h1 class="page-title">Comments</h1>
                <p class="page-subtitle">Review and moderate user comments</p>
            </div>
            <div class="header-actions">
                <button id="delete-selected" class="btn btn-danger" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Delete Selected
                </button>
            </div>
        </div>
    </header>

    <div class="page-content">
        {error ? (
            <div class="error-card">
                <div class="error-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </div>
                <div class="error-content">
                    <h3>Error Loading Comments</h3>
                    <p>{error}</p>
                    <p class="error-hint">Please check your Redis configuration and try again.</p>
                </div>
            </div>
        ) : (
            <>
                <!-- Stats -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value">{allComments.length}</span>
                            <span class="stat-label">Total Comments</span>
                        </div>
                    </div>
                </div>

                <!-- Comments Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="header-left">
                            <input type="checkbox" id="select-all" class="checkbox" />
                            <h2 class="card-title">All Comments</h2>
                        </div>
                        <span class="selection-count" id="selection-count"></span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px"></th>
                                    <th>Author</th>
                                    <th>Comment</th>
                                    <th style="width: 150px">Location</th>
                                    <th style="width: 100px">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {allComments.length === 0 ? (
                                    <tr>
                                        <td colspan="5" class="empty-state">
                                            <div class="empty-icon">
                                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                                </svg>
                                            </div>
                                            <p>No comments yet</p>
                                            <span>Comments will appear here when visitors leave them on creatures</span>
                                        </td>
                                    </tr>
                                ) : (
                                    allComments.map(comment => (
                                        <tr>
                                            <td>
                                                <input
                                                    type="checkbox"
                                                    class="checkbox comment-checkbox"
                                                    data-id={comment.id}
                                                    data-creature-id={comment.creatureId}
                                                />
                                            </td>
                                            <td>
                                                <div class="author-cell">
                                                    <span class="author-emoji">{comment.emoji || 'ðŸ‘¤'}</span>
                                                    <div class="author-info">
                                                        <span class="author-name">{comment.name}</span>
                                                        {comment.email && (
                                                            <span class="author-email">{comment.email}</span>
                                                        )}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <p class="comment-text">{comment.comment}</p>
                                            </td>
                                            <td>
                                                <a
                                                    href={comment.creatureId === 'about' ? '/about' : `/creature/${comment.creatureId}`}
                                                    target="_blank"
                                                    class="location-link"
                                                >
                                                    {comment.creatureId === 'about'
                                                        ? 'About Page'
                                                        : creatureMap.get(comment.creatureId!) || comment.creatureId}
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                                        <polyline points="15 3 21 3 21 9"/>
                                                        <line x1="10" y1="14" x2="21" y2="3"/>
                                                    </svg>
                                                </a>
                                            </td>
                                            <td>
                                                <span class="date-cell" title={new Date(comment.createdAt).toLocaleString()}>
                                                    {formatDate(comment.createdAt)}
                                                </span>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            </>
        )}
    </div>
</AdminLayout>

<style>
    /* Header */
    .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
    }

    /* Stats Row */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 300px));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: var(--admin-surface);
        border: 1px solid var(--admin-border);
        border-radius: 8px;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(168, 85, 247, 0.15);
        color: var(--color-engagement);
    }

    .stat-info {
        display: flex;
        flex-direction: column;
    }

    /* Card Header */
    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .selection-count {
        font-size: 0.8125rem;
        color: var(--admin-accent);
        font-weight: 500;
    }

    /* Author Cell */
    .author-cell {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .author-emoji {
        font-size: 1.5rem;
        line-height: 1;
    }

    .author-info {
        display: flex;
        flex-direction: column;
    }

    .author-name {
        font-weight: 600;
        color: var(--admin-text);
    }

    .author-email {
        font-size: 0.75rem;
        color: var(--admin-text-muted);
    }

    /* Comment Cell */
    .comment-text {
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        color: var(--admin-text-muted);
        font-size: 0.875rem;
        line-height: 1.5;
    }

    /* Location Link */
    .location-link {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        color: var(--admin-text);
        text-decoration: none;
        font-size: 0.8125rem;
        font-weight: 500;
        transition: color 0.15s ease;
    }

    .location-link:hover {
        color: var(--admin-accent);
    }

    .location-link svg {
        opacity: 0;
        transition: opacity 0.15s ease;
    }

    .location-link:hover svg {
        opacity: 1;
    }

    /* Date Cell */
    .date-cell {
        font-size: 0.8125rem;
        color: var(--admin-text-muted);
        cursor: default;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem !important;
    }

    .empty-icon {
        color: var(--admin-text-dim);
        margin-bottom: 1rem;
    }

    .empty-state p {
        font-weight: 600;
        color: var(--admin-text);
        margin-bottom: 0.25rem;
    }

    .empty-state span {
        font-size: 0.8125rem;
        color: var(--admin-text-muted);
    }

    /* Error Card */
    .error-card {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        padding: 2rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .error-icon {
        color: var(--admin-danger);
        flex-shrink: 0;
    }

    .error-content h3 {
        color: var(--admin-danger);
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }

    .error-content p {
        color: var(--admin-text);
        margin-bottom: 0.5rem;
    }

    .error-hint {
        font-size: 0.8125rem;
        color: var(--admin-text-muted);
    }

    /* Row Selection Highlight */
    tr:has(.checkbox:checked) td {
        background: rgba(99, 102, 241, 0.1);
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .header-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .comment-text {
            max-width: 200px;
        }
    }
</style>

<script is:inline>
    const selectAllCheckbox = document.getElementById('select-all');
    const commentCheckboxes = document.querySelectorAll('.comment-checkbox');
    const deleteButton = document.getElementById('delete-selected');
    const selectionCount = document.getElementById('selection-count');

    function updateUI() {
        const checkedCount = Array.from(commentCheckboxes).filter(cb => cb.checked).length;
        const allChecked = checkedCount === commentCheckboxes.length && commentCheckboxes.length > 0;

        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = checkedCount > 0 && !allChecked;
        }

        if (deleteButton) {
            deleteButton.disabled = checkedCount === 0;
        }

        if (selectionCount) {
            selectionCount.textContent = checkedCount > 0 ? `${checkedCount} selected` : '';
        }
    }

    selectAllCheckbox?.addEventListener('change', () => {
        commentCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updateUI();
    });

    commentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateUI);
    });

    deleteButton?.addEventListener('click', async () => {
        const selectedComments = Array.from(commentCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => ({
                id: cb.dataset.id,
                creatureId: cb.dataset.creatureId
            }));

        if (selectedComments.length === 0) return;

        const confirmMsg = `Are you sure you want to delete ${selectedComments.length} comment${selectedComments.length !== 1 ? 's' : ''}? This action cannot be undone.`;

        if (!confirm(confirmMsg)) return;

        try {
            const response = await fetch('/api/admin/delete-comments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comments: selectedComments })
            });

            if (response.ok) {
                window.showToast('success', 'Comments Deleted', `Successfully deleted ${selectedComments.length} comment${selectedComments.length !== 1 ? 's' : ''}`);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                const error = await response.json();
                window.showToast('error', 'Delete Failed', error.message || 'Failed to delete comments');
            }
        } catch (error) {
            window.showToast('error', 'Delete Failed', 'An unexpected error occurred');
        }
    });
</script>
